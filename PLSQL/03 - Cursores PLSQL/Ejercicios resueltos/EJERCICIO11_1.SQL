 
DECLARE
    V_ERROR_CODE NUMBER;
    V_ERROR_MESSAGE VARCHAR2(255);
    V_ID_LIQUIDACION NUMBER;
    V_SALARIO_BASICO B_CATEGORIAS_SALARIALES.ASIGNACION%TYPE := 0;
    DESCUENTO_IPS NUMBER(4,3) := 0.095;
    BONIFICACION_X_VENTA NUMBER(7) := 0;
    V_SALARIO_LIQUIDO NUMBER(8);
BEGIN
	INSERT INTO B_LIQUIDACION VALUES (
	(SELECT (MAX(ID) + 1) FROM B_LIQUIDACION),
	SYSDATE,
	2018,
	8
	)RETURNING id INTO v_id_liquidacion;

    FOR R_EMPLEADOS IN (SELECT CEDULA FROM B_EMPLEADOS) LOOP
        -- HALLAMOS EL SALARIO BASICO DEL EMPLEADO 
        BEGIN
            SELECT CS.ASIGNACION
            INTO V_SALARIO_BASICO
            FROM B_POSICION_ACTUAL PA 
            INNER JOIN B_CATEGORIAS_SALARIALES CS ON PA.COD_CATEGORIA = CS.COD_CATEGORIA
            WHERE PA.CEDULA = R_EMPLEADOS.CEDULA AND PA.FECHA_FIN IS NULL;
            --DBMS_OUTPUT.PUT_LINE('EL EMPLEADO: ' || R_EMPLEADOS.CEDULA || ' SALARIO BASICO: ' || V_SALARIO_BASICO);
			
			
			-- HALLAMOS LAS BONIFICACIONES POR VENTAS DEL EMPLEADO
			SELECT NVL(SUM(DV.PRECIO * DV.CANTIDAD * A.PORC_COMISION), 0) 
			INTO BONIFICACION_X_VENTA
			FROM B_VENTAS V
			INNER JOIN B_DETALLE_VENTAS DV ON V.ID = DV.ID_VENTA
			INNER JOIN B_ARTICULOS A ON DV.ID_ARTICULO = A.ID
			WHERE EXTRACT(YEAR FROM V.FECHA) = 2018 AND EXTRACT(MONTH FROM V.FECHA) = 8 AND V.CEDULA_VENDEDOR = R_EMPLEADOS.CEDULA;
			--DBMS_OUTPUT.PUT_LINE('EL EMPLEADO:'||R_EMPLEADOS.CEDULA||' BONIFICACION_X_VENTA: '||BONIFICACION_X_VENTA);
			IF SQL%FOUND THEN
				V_SALARIO_LIQUIDO := V_SALARIO_BASICO - (V_SALARIO_BASICO * DESCUENTO_IPS) + BONIFICACION_X_VENTA;
				INSERT INTO B_PLANILLA (ID_LIQUIDACION, CEDULA, SALARIO_BASICO, DESCUENTO_IPS, BONIFICACION_X_VENTAS, LIQUIDO_COBRADO) VALUES (
					V_ID_LIQUIDACION,
					R_EMPLEADOS.CEDULA,
					V_SALARIO_BASICO,
					V_SALARIO_BASICO * DESCUENTO_IPS,
					BONIFICACION_X_VENTA,
					V_SALARIO_LIQUIDO
				);
				DBMS_OUTPUT.PUT_LINE('INSERCION EXITOSA.');
			END IF;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                DBMS_OUTPUT.PUT_LINE('NO SE ENCONTRÓ INFORMACIÓN PARA EL EMPLEADO: ' || R_EMPLEADOS.CEDULA);
        END;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        V_ERROR_CODE := SQLCODE;
        V_ERROR_MESSAGE := SQLERRM;
        DBMS_OUTPUT.PUT_LINE (TO_CHAR(V_ERROR_CODE)||': '|| V_ERROR_MESSAGE);
        ROLLBACK;
END;
/
