SET SERVEROUTPUT ON
CREATE OR REPLACE PACKAGE PACK_PER AS
	TYPE R_PER IS RECORD (
		MONTO_VENTAS B_VENTAS.MONTO_TOTAL%TYPE,
		MONTO_COMISION NUMBER(9)
	);
	TYPE T_PER IS TABLE OF R_PER INDEX BY BINARY_INTEGER;
	V_CALCULA_BONIFI BOOLEAN := TRUE;
	FUNCTION  F_APELLIDO_NOMBRE (P_CED NUMBER) RETURN VARCHAR2;
	FUNCTION F_CALCULAR_BONIFICACION (P_ANO NUMBER, P_MES NUMBER) RETURN T_PER;
	FUNCTION F_CALCULAR_BONIFICACIÓN (P_CEDULA_E NUMBER) RETURN NUMBER;
END;
/

CREATE OR REPLACE PACKAGE BODY PACK_PER IS
	FUNCTION  F_APELLIDO_NOMBRE (P_CED NUMBER) RETURN VARCHAR2 IS
		V_APE_NOM VARCHAR2(50):= 'NO TIENE JEFE';
	BEGIN
		SELECT E.APELLIDO||', '||E.NOMBRE
		INTO V_APE_NOM
		FROM B_EMPLEADOS E
		WHERE E.CEDULA = P_CED;
		IF SQL%FOUND THEN
			RETURN V_APE_NOM;
		ELSE
			RETURN V_APE_NOM;
		END IF;
	END F_APELLIDO_NOMBRE;
	
	FUNCTION F_CALCULAR_BONIFICACION (P_ANO NUMBER, P_MES NUMBER) RETURN T_PER IS
		T_BONIFICACION T_PER;
		CURSOR C_BONI IS
			SELECT 
			V.CEDULA_VENDEDOR,
			NVL(SUM(V.MONTO_TOTAL),0) TOTAL_V,
			NVL(SUM(DV.CANTIDAD * DV.PRECIO * A.PORC_COMISION),0) BONI
			FROM B_VENTAS V
			INNER JOIN B_DETALLE_VENTAS DV ON V.ID = DV.ID_VENTA
			INNER JOIN B_ARTICULOS A ON DV.ID_ARTICULO = A.ID
			WHERE EXTRACT(YEAR FROM V.FECHA) = P_ANO AND EXTRACT(MONTH FROM V.FECHA) = P_MES
			GROUP BY V.CEDULA_VENDEDOR;

	BEGIN
		FOR R_BONI IN C_BONI LOOP
			T_BONIFICACION(R_BONI.CEDULA_VENDEDOR).MONTO_VENTAS:= R_BONI.TOTAL_V;
			T_BONIFICACION(R_BONI.CEDULA_VENDEDOR).MONTO_COMISION:= R_BONI.BONI;
		END LOOP;
		RETURN T_BONIFICACION;
	END F_CALCULAR_BONIFICACION;
	
	FUNCTION F_CALCULAR_BONIFICACIÓN (P_CEDULA_E NUMBER) RETURN NUMBER IS
		V_BONI NUMBER(9);
	BEGIN
		SELECT 
			NVL(SUM(DV.CANTIDAD * DV.PRECIO * A.PORC_COMISION),0) BONI
		INTO V_BONI
		FROM B_VENTAS V
		INNER JOIN B_DETALLE_VENTAS DV ON V.ID = DV.ID_VENTA
		INNER JOIN B_ARTICULOS A ON DV.ID_ARTICULO = A.ID
		WHERE EXTRACT(YEAR FROM V.FECHA) = EXTRACT(YEAR FROM SYSDATE) AND EXTRACT(MONTH FROM V.FECHA) = EXTRACT(MONTH FROM SYSDATE)
		AND V.CEDULA_VENDEDOR = P_CEDULA_E;
		RETURN V_BONI;
	END F_CALCULAR_BONIFICACIÓN;
	

END;
/

/*PRUEBAS*/

SELECT E.CEDULA, PACK_PER.F_APELLIDO_NOMBRE(E.CEDULA), PACK_PER.F_APELLIDO_NOMBRE(E.CEDULA_JEFE)
FROM B_EMPLEADOS E;

DECLARE 
V_BONIF PACK_PER.T_PER;
V_INDICE BINARY_INTEGER;
BEGIN
	IF PACK_PER.V_CALCULA_BONIFI = TRUE THEN
		V_BONIF := PACK_PER.F_CALCULAR_BONIFICACION(2018,7);
		V_INDICE := V_BONIF.FIRST;
		WHILE V_INDICE <= V_BONIF.LAST LOOP
			DBMS_OUTPUT.PUT_LINE('CEDULA: ' || V_INDICE || ' MONTO VENTA: ' ||V_BONIF(V_INDICE).MONTO_VENTAS||' MONTO BONIFICACION: '||V_BONIF(V_INDICE).MONTO_COMISION);
			V_INDICE := V_BONIF.NEXT(V_INDICE);  
		END LOOP;
	END IF;
	
END;

