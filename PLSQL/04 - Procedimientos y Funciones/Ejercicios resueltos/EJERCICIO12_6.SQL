CREATE OR REPLACE PROCEDURE P_ULTIMA_COMPRA IS
	V_FECHA B_COMPRAS.FECHA%TYPE;
    CURSOR C_ARTICULOS IS
        SELECT ID, ULTIMA_COMPRA
        FROM B_ARTICULOS
        FOR UPDATE OF ULTIMA_COMPRA;
		 R_ART C_ARTICULOS%ROWTYPE;
	BEGIN
		FOR R_ART IN C_ARTICULOS LOOP
			SELECT MAX(C.FECHA)
			INTO V_FECHA
			FROM B_COMPRAS C 
			INNER JOIN B_DETALLE_COMPRAS DC ON C.ID = DC.ID_COMPRA
			WHERE DC.ID_ARTICULO = R_ART.ID;
			IF V_FECHA IS NOT NULL THEN
				UPDATE B_ARTICULOS
				SET ULTIMA_COMPRA = V_FECHA
				WHERE CURRENT OF C_ARTICULOS;
			END IF;
		END LOOP;
	EXCEPTION
	WHEN NO_DATA_FOUND THEN
			-- Manejo de excepción cuando no se encuentra ningún dato
			DBMS_OUTPUT.PUT_LINE('No se encontró Compra del articulo ID: ' ||R_ART.ID);
	WHEN OTHERS THEN
		-- Manejo de otras excepciones
		DBMS_OUTPUT.PUT_LINE('Error: ' || SQLCODE || ' - ' || SQLERRM);
	END;
	
	--EXEC P_GENERAR_PLAN();